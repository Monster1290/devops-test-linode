# tasks file for jenkins_agent
---
- name: Add an apt signing key for k8s
  apt_key:
    url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
    state: present

- name: Add k8s apt repository
  apt_repository:
    repo: deb https://apt.kubernetes.io/ kubernetes-xenial main
    state: present

- name: Install dependencies
  apt:
    name:
    - apt-transport-https
    - openjdk-11-jre-headless
    - kubectl
    state: present
    update_cache: yes

- name: Create jenkins user
  user:
    name: jenkins
    password: jenkins
    home: "{{jenkins_home}}"
    shell: "/bin/bash"
    append: yes
    groups:
      - sudo
      - docker

- name: Create .ssh directory for jenkins
  file:
    path: "{{jenkins_home}}/.ssh"
    state: directory

- name: Copy SSH public key
  copy:
    src: jenkins_agent.pub
    dest: "{{jenkins_home}}/.ssh/authorized_keys"
    mode: 0600
    owner: jenkins
    group: jenkins

- name: Disable SSH access via password
  include_role:
    name: willshersystems.sshd
  vars:
    sshd:
      Match:
      - Condition: "User jenkins"
        PasswordAuthentication: no
